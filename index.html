
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>哥有石头</title>
	<meta name="author" content="Atpking">

	
	<meta name="description" content="controller, rails, test Rails 测试 Controller Action 的方式 之前写 Rails 测试都是从 models 来写的，原因很简单，controller 的逻辑一般比较简单，不会太容易出错，而 model 里的逻辑比较复杂，稍不留神就会出现问题， &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="/atom.xml" rel="alternate" title="哥有石头" type="application/atom+xml">
	
	<link rel="canonical" href="http://jicheng1014.github.io/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="http://lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>
	
</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">	
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		document.write("<img src='http://www.gravatar.com/avatar/" + MD5("atpking@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
	</script>
</div>
<h1><a href="/">哥有石头</a></h1>
<p class="subtitle">现在也有米有水果.</p>
<nav id="main-nav"><ul class="main">
	<li><a href="/">Blog</a></li>
	<li><a href="/blog/archives">Archives</a></li>
</ul>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="weibo" href="http://www.weibo.com/atpking" title="Weibo">Weibo</a>
		
		
		
		
		
		<a class="github" href="https://github.com/jicheng1014@gmail.com" title="GitHub">GitHub</a>
		
		
		
		
		
		
		
		<a class="rss" href="/atom.xml" title="RSS">RSS</a>
		
	</div>
</nav>

</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-04-10T17:53:06+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/controller/'>controller</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/test/'>test</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2016/04/10/rails-test-controller/" itemprop="url">Rails 测试 Controller Action 的方式</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>之前写 Rails 测试都是从 models 来写的，原因很简单，controller 的逻辑一般比较简单，不会太容易出错，而 model 里的逻辑比较复杂，稍不留神就会出现问题，只能多测。</p>

<p>但是这种思想就导致了 controller 甚至都不想跑，写完了就直接运行。随着项目的进度不断前进，controller 里的 action 越来越多，同时一次写对的概率也变少了很多，特别是在跟前端对接的时候，状况不断。</p>

<p>本着 <code>吃自己的狗食</code> 的精神，我也开始慢慢的写了一些 controller 的测试</p>

<p>网上关于 controller 的测试大多数都是基于 RSepc 的，由于我不太喜欢这个东西，所以自己使用的是官方默认的 MiniTest, 看了一下官方的源码   大概是这么个样子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">FlowTemplatesControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;could list all flow templates&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">get</span> <span class="ss">:index</span>
</span><span class='line'>    <span class="n">assert_response</span> <span class="ss">:success</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">get</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">language</span><span class="p">:</span> <span class="s2">&quot;ruby&quot;</span>
</span><span class='line'>    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_response</span> <span class="ss">:success</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">FlowTemplate</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="ss">language</span><span class="p">:</span> <span class="s2">&quot;ruby&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;could show flow template&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">flow_template</span> <span class="o">=</span> <span class="no">FlowTemplate</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="n">response</span> <span class="o">=</span> <span class="n">get</span> <span class="ss">:show</span><span class="p">,</span> <span class="nb">id</span><span class="p">:</span> <span class="n">flow_template</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">json</span> <span class="o">=</span> <span class="no">JSON</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="n">flow_template</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">json</span><span class="o">[</span><span class="s2">&quot;name&quot;</span><span class="o">]</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>能说的可能就是 这个地方可以支持 get post patch delete 了，之后这里会默认找这个 test 命名中对应的 controller。</p>

<p>上面的是最普通的情况，在实际的测试当中，有时候我们还会遇到诸如 这个地方需要登录的情况，但是我在 controller 里手动的去登录非常麻烦（这也是我不想写 controller 的测试的主要原因），其实可以用 instance_eval 来解决这个问题</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;test_helper&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">ProjectsControllerTest</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class='line'>  <span class="n">setup</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span> <span class="o">||</span> <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@controller</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>      <span class="vi">@current_user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;could list all projects&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">Fabricate</span><span class="p">(</span><span class="ss">:project</span><span class="p">,</span> <span class="ss">user</span><span class="p">:</span> <span class="vi">@user</span><span class="p">)</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="no">User</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span> <span class="no">Project</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">to_s</span>
</span><span class='line'>    <span class="n">get</span> <span class="ss">:index</span>
</span><span class='line'>    <span class="n">assert_response</span> <span class="ss">:success</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="nb">test</span> <span class="s2">&quot;could create project&quot;</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">0</span><span class="p">,</span> <span class="no">Project</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>    <span class="n">post</span> <span class="ss">:create</span><span class="p">,</span> <span class="p">{</span> <span class="nb">name</span><span class="p">:</span> <span class="s2">&quot;jicheng1014/test&quot;</span><span class="p">,</span> <span class="ss">source</span><span class="p">:</span> <span class="s2">&quot;github&quot;</span><span class="p">,</span> <span class="ss">git_url</span><span class="p">:</span> <span class="s2">&quot;git@github.com:jicheng1014/test.git&quot;</span> <span class="p">}</span>
</span><span class='line'>    <span class="n">assert_response</span> <span class="ss">:success</span>
</span><span class='line'>    <span class="n">assert_equal</span> <span class="mi">1</span><span class="p">,</span> <span class="no">Project</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>大概就是上面这样， have fun</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2016-04-10T11:54:20+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/test/'>test</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2016/04/10/chi-zi-ji-de-gou-liang/" itemprop="url">吃自己的狗粮</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>testerhome 是我比较喜欢的网站, 但是这个网站我觉得有一个点我不是很赞同：让测试人员去猜测诸如内存抖动、cpu 消耗、弱网状态下的问题的原因。</p>

<p>当然这跟测试本身的定位有关，我更觉得这些事情应该是开发来干的。</p>

<p>比如内存抖动，作为测试，很难直接知道具体的问题。他能做的最多的就是告诉你：我在加载某个 list 的时候，发现内存抖动，所以我判断是你在 item 的渲染的时候没有做很好处理。但是如果这个事情是研发拿到了，事情就好办多了：哦，内存抖了. 恩，是跑这块代码的，，我来看看是怎么写的，图片加载了没缓存，git blame &hellip; 小王你不能这么业余啊。</p>

<p>那测试的作用是什么呢？ 我觉得更多的是教研发怎么测，写自动化测试，把结果给研发，至于具体的哪里出问题，直接喊研发找就好了，测试在那里苦思冥想 1 个小时不如研发直接看代码是哪个地方出问题。</p>

<p>或者这也是现在 QA 团队规模越来越小的原因吧。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-04-24T14:14:56+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/04/24/learning-asset-pipeline/" itemprop="url">Learning Asset Pipeline</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h1>Asset Pipeline 的复习</h1>

<h2>概念</h2>

<p><strong>是什么</strong></p>

<ul>
<li>Asset pipeline 是一款压缩css 和js 的预处理工具。中间件叫Sprockets</li>
</ul>


<p><strong>目的</strong></p>

<ul>
<li>降低连接次数</li>
<li>有效建立缓存</li>
</ul>


<p><strong>构成</strong></p>

<ul>
<li>uglifier</li>
<li>sass-rails</li>
<li>coffee-rails</li>
</ul>


<h2>使用</h2>

<p><strong>静态资源放置</strong>
放在app/assets 文件夹中</p>

<p><strong>引入资源</strong></p>

<p>有两种方案</p>

<ol>
<li>一次性引入所有文件   （使用require_tree）</li>
<li>只引用对应控制器的assets(不使用require_tree)</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">&lt;</span><span class="sx">%= javascript_include_tag params[:controller] %&gt;</span>
</span><span class='line'><span class="sx">&lt;%=</span> <span class="n">stylesheet_link_tag</span> <span class="n">params</span><span class="o">[</span><span class="ss">:controller</span><span class="o">]</span> <span class="o">%&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>加载时搜索的路径</strong></p>

<p>在使用静态资源的时候Sprockets 会再默认的三个位置中查找对应的文件
- apps/assets/(images|javascripts|stylesheets)
- 也会寻找其他文件夹？</p>

<p><strong>资源引用</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='js'><span class='line'><span class="c1">//= require home (初级目录，不用加后缀)</span>
</span><span class='line'><span class="c1">//= require sub/something   （子目录）</span>
</span></code></pre></td></tr></table></div></figure>


<p>使用<code>Rails.application.config.assets.paths</code>就可以看到所有的搜索路径</p>

<p>如果需要自定义路径，则需要在application.rb  增加配置</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">paths</span> <span class="o">&lt;&lt;</span> <span class="no">Rails</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;lib&quot;</span><span class="p">,</span> <span class="s2">&quot;videoplayer&quot;</span><span class="p">,</span> <span class="s2">&quot;flash&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>app/assets 优先级别高一点</p>

<p>注意，如果清单文件没有包含某个需要引用的文件，则我们需要手动的将其加入在包含里    参见上面的代码</p>

<p><strong>在Production 中的预处理</strong></p>

<p>$ RAILS_ENV=production bin/rake assets:precompile</p>

<p><strong>添加其他的mainfest 文件</strong></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Rails</span><span class="o">.</span><span class="n">application</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">precompile</span> <span class="o">+=</span> <span class="o">[</span><span class="s1">&#39;admin.js&#39;</span><span class="p">,</span> <span class="s1">&#39;admin.css&#39;</span><span class="p">,</span> <span class="s1">&#39;swfObject.js&#39;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>这个地方注意一下，这里的后缀不是文件的后缀  而是得到的文件的后缀(  scss   coffee)</p>

<h3>将静态文件设置过期时间</h3>

<p>因为已经生成了指纹，所以缓存时间可以设置成无限长</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="sr">//n</span><span class="n">ginx</span>
</span><span class='line'><span class="n">location</span> <span class="o">~</span> <span class="o">^/</span><span class="n">assets</span><span class="o">/</span> <span class="p">{</span>
</span><span class='line'>  <span class="n">expires</span> <span class="mi">1</span><span class="n">y</span><span class="p">;</span>
</span><span class='line'>  <span class="n">add_header</span> <span class="no">Cache</span><span class="o">-</span><span class="no">Control</span> <span class="kp">public</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">add_header</span> <span class="no">ETag</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>  <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># apache</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># The Expires* directives requires the Apache module</span>
</span><span class='line'><span class="c1"># `mod_expires` to be enabled.</span>
</span><span class='line'><span class="o">&lt;</span><span class="no">Location</span> <span class="sr">/assets/</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="c1"># Use of ETag is discouraged when Last-Modified is present</span>
</span><span class='line'>  <span class="no">Header</span> <span class="n">unset</span> <span class="no">ETag</span> <span class="no">FileETag</span> <span class="no">None</span>
</span><span class='line'>  <span class="c1"># RFC says only cache for 1 year</span>
</span><span class='line'>  <span class="no">ExpiresActive</span> <span class="no">On</span> <span class="no">ExpiresDefault</span> <span class="s2">&quot;access plus 1 year&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="sr">/Location&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-04-20T11:56:47+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/04/20/how-to-use-active-job-in-rails-4-dot-2/" itemprop="url">初探ActiveJob</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>初探ActiveJob</h2>

<h3>简介</h3>

<p>ActiveJob 是 Rails 4.2 新加入的功能。这个东西在beta阶段rubyChina就已经有很多高手关注了，无奈自己的项目使用的是4.1.5，升级到4.2 的时候其他gem又有很多依赖有问题，所以没在第一时间使用。今天补个课。</p>

<p>ActiveJob 是Rails自己开发运行后台程序的模块，常用于执行运行时间可能很长的工作（比如发送注册邮件）。</p>

<p>当然这种需求实际上非常普遍，所以rails 也有相应的第三方gem来解决这个需求，比如著名的Sidekiq和Resque等。<strong>ActiveJob的出现不是为了代替他们</strong>，而是统一了原来Resque、Sidekiq 等其他gem对后台运行程序的各种千奇百怪的写法。</p>

<h3>定义</h3>

<p>ActiveJob 的使用官方文档已经给出了示例
首先在命令行中使用 <code>rails g job JOBNAME</code> 来新建一个任务</p>

<p>比如这里</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>➜  my_rails42 git:(master) ✗ rails g job add_lots_of_users
</span><span class='line'>      invoke  test_unit
</span><span class='line'>      create    test/jobs/add_lots_of_users_job_test.rb
</span><span class='line'>      create  app/jobs/add_lots_of_users_job.rb
</span><span class='line'>➜  my_rails42 git:(master) ✗</span></code></pre></td></tr></table></div></figure>


<p>我们打开add_lots_of_users_job.rb，可以看到下列内容</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">AddLotsOfUsersJob</span> <span class="o">&lt;</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">queue_as</span> <span class="ss">:default</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Do something later</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以将耗时的内容写入<code>perform</code>里</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">perform</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class='line'>    <span class="c1"># Do something later</span>
</span><span class='line'>    <span class="nb">sleep</span> <span class="mi">10</span>
</span><span class='line'>    <span class="mi">1000</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">index</span><span class="o">|</span>
</span><span class='line'>      <span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;atpking</span><span class="si">#{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，我在job 里建立了一个作业，先睡10秒，再插入1000条数据到数据库中</p>

<p>至此，我们就成功建立了一个job了，接下来，就是使用了</p>

<h3>使用</h3>

<p>官方demo讲的非常简单，就是在你使用的地方用这个句子：<code>XXJob.perform_later PARAMS</code></p>

<p>比如我这里</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">UsersController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
</span><span class='line'>  <span class="n">before_action</span> <span class="ss">:set_user</span><span class="p">,</span> <span class="ss">only</span><span class="p">:</span> <span class="o">[</span><span class="ss">:show</span><span class="p">,</span> <span class="ss">:edit</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># GET /users</span>
</span><span class='line'>  <span class="c1"># GET /users.json</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="no">AddLotsOfUsersJob</span><span class="o">.</span><span class="n">perform_later</span>
</span><span class='line'>    <span class="vi">@users</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">all</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>
我们运行一下试试</p>

<p>运行过程中发现<strong>不像我们预想的那样</strong>，而是访问index 的时候，活生生的等待了10多秒,在获得@users</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">AddLotsOfUsersJob</span><span class="o">]</span> <span class="o">[</span><span class="n">e191c62d</span><span class="o">-</span><span class="mi">68</span><span class="n">a9</span><span class="o">-</span><span class="mi">425</span><span class="n">f</span><span class="o">-</span><span class="mi">8</span><span class="n">a94</span><span class="o">-</span><span class="n">b9fe080c141c</span><span class="o">]</span>    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">8</span><span class="n">ms</span><span class="p">)</span>  <span class="n">commit</span> <span class="n">transaction</span>
</span><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">AddLotsOfUsersJob</span><span class="o">]</span> <span class="o">[</span><span class="n">e191c62d</span><span class="o">-</span><span class="mi">68</span><span class="n">a9</span><span class="o">-</span><span class="mi">425</span><span class="n">f</span><span class="o">-</span><span class="mi">8</span><span class="n">a94</span><span class="o">-</span><span class="n">b9fe080c141c</span><span class="o">]</span>    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>  <span class="k">begin</span> <span class="n">transaction</span>
</span><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">AddLotsOfUsersJob</span><span class="o">]</span> <span class="o">[</span><span class="n">e191c62d</span><span class="o">-</span><span class="mi">68</span><span class="n">a9</span><span class="o">-</span><span class="mi">425</span><span class="n">f</span><span class="o">-</span><span class="mi">8</span><span class="n">a94</span><span class="o">-</span><span class="n">b9fe080c141c</span><span class="o">]</span>   <span class="no">SQL</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">INSERT</span> <span class="no">INTO</span> <span class="s2">&quot;users&quot;</span> <span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;updated_at&quot;</span><span class="p">)</span> <span class="no">VALUES</span> <span class="p">(</span><span class="sc">?,</span> <span class="sc">?,</span> <span class="sc">?)</span>  <span class="o">[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;atpking999&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;created_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2015-04-20 04:30:29.320703&quot;</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="s2">&quot;2015-04-20 04:30:29.320703&quot;</span><span class="o">]]</span>
</span><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">AddLotsOfUsersJob</span><span class="o">]</span> <span class="o">[</span><span class="n">e191c62d</span><span class="o">-</span><span class="mi">68</span><span class="n">a9</span><span class="o">-</span><span class="mi">425</span><span class="n">f</span><span class="o">-</span><span class="mi">8</span><span class="n">a94</span><span class="o">-</span><span class="n">b9fe080c141c</span><span class="o">]</span>    <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span><span class="p">)</span>  <span class="n">commit</span> <span class="n">transaction</span>
</span><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="o">[</span><span class="no">AddLotsOfUsersJob</span><span class="o">]</span> <span class="o">[</span><span class="n">e191c62d</span><span class="o">-</span><span class="mi">68</span><span class="n">a9</span><span class="o">-</span><span class="mi">425</span><span class="n">f</span><span class="o">-</span><span class="mi">8</span><span class="n">a94</span><span class="o">-</span><span class="n">b9fe080c141c</span><span class="o">]</span> <span class="no">Performed</span> <span class="no">AddLotsOfUsersJob</span> <span class="n">from</span> <span class="no">Inline</span><span class="p">(</span><span class="n">default</span><span class="p">)</span> <span class="k">in</span> <span class="mi">12789</span><span class="o">.</span><span class="mi">38</span><span class="n">ms</span>
</span><span class='line'>  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">2</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;users&quot;</span>
</span><span class='line'>  <span class="no">Rendered</span> <span class="n">users</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span> <span class="n">within</span> <span class="n">layouts</span><span class="o">/</span><span class="n">application</span> <span class="p">(</span><span class="mi">186</span><span class="o">.</span><span class="mi">7</span><span class="n">ms</span><span class="p">)</span>
</span><span class='line'><span class="no">Completed</span> <span class="mi">200</span> <span class="no">OK</span> <span class="k">in</span> <span class="mi">13210</span><span class="n">ms</span> <span class="p">(</span><span class="ss">Views</span><span class="p">:</span> <span class="mi">392</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span> <span class="o">|</span> <span class="ss">ActiveRecord</span><span class="p">:</span> <span class="mi">1166</span><span class="o">.</span><span class="mi">0</span><span class="n">ms</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>注意看上面，很多歌ActiveJob 完毕了之后，输出<code>Performed AddLotsOfUsersJob from Inline(default) in 12789.38ms</code>,再执行的<code>select * from users</code></p>

<p>也就是说，默认情况下的ActiveJob 跟我们使用的方法没什么区别，<code>是阻塞</code>的,实际上官方文档也说明了</p>

<blockquote><p>4 Job Execution
If no adapter is set, the job is immediately executedIf no adapter is set, the job is immediately executed.</p></blockquote>

<p>那么我们需要给ActiveJob 指定一个Adapter 了。官方有支持以下的adapter，功能有所不同，需要注意。如果没设定，则是默认的 Active Job Inline ，可以看到一个悲剧，<strong>不支持异步（Async）</strong>，这也是为何我们刚刚等了很长时间</p>

<table>
<thead>
<tr>
<th> function</th>
<th> Async </th>
<th> Queues </th>
<th> Delayed   </th>
<th> Priorities </th>
<th> Timeout </th>
<th> Retries </th>
</tr>
</thead>
<tbody>
<tr>
<td> Backburner        </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes       </td>
<td> Yes        </td>
<td> Job     </td>
<td> Global  </td>
</tr>
<tr>
<td> Delayed Job       </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes       </td>
<td> Job        </td>
<td> Global  </td>
<td> Global  </td>
</tr>
<tr>
<td> Qu                </td>
<td> Yes   </td>
<td> Yes    </td>
<td> No        </td>
<td> No         </td>
<td> No      </td>
<td> Global  </td>
</tr>
<tr>
<td> Que               </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes       </td>
<td> Job        </td>
<td> No      </td>
<td> Job     </td>
</tr>
<tr>
<td> queue_classic     </td>
<td> Yes   </td>
<td> Yes    </td>
<td> No*       </td>
<td> No         </td>
<td> No      </td>
<td> No      </td>
</tr>
<tr>
<td> Resque            </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes (Gem) </td>
<td> Queue      </td>
<td> Global  </td>
<td> Yes     </td>
</tr>
<tr>
<td> Sidekiq           </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes       </td>
<td> Queue      </td>
<td> No      </td>
<td> Job     </td>
</tr>
<tr>
<td> Sneakers          </td>
<td> Yes   </td>
<td> Yes    </td>
<td> No        </td>
<td> Queue      </td>
<td> Queue   </td>
<td> No      </td>
</tr>
<tr>
<td> Sucker Punch      </td>
<td> Yes   </td>
<td> Yes    </td>
<td> No        </td>
<td> No         </td>
<td> No      </td>
<td> No      </td>
</tr>
<tr>
<td> Active Job Inline(默认的) </td>
<td> No    </td>
<td> Yes    </td>
<td> N/A       </td>
<td> N/A        </td>
<td> N/A     </td>
<td> N/A     </td>
</tr>
<tr>
<td> Active Job        </td>
<td> Yes   </td>
<td> Yes    </td>
<td> Yes       </td>
<td> No         </td>
<td> No      </td>
<td> No      </td>
</tr>
</tbody>
</table>


<p>我选用了sidekiq 作为Adapter，注意这里，你必须要安装过sidekiq,  没安装自然需要你Gemfile 里加一句咯      同时还要安装redis，之后在命令行使用 redis-server &amp; 启用redis 同时也得在命令行里启用sidekiq,直接输入sidekiq &amp; 即可</p>

<p>之后我们需要指定sidekiq 为我们的adapter，我们需要在application.rb 里加入一句话</p>

<p><code>config.active_job.queue_adapter = :sidekiq</code></p>

<p>再次运行index 页面，我们看rails 的日志，就变成了先执行Select * from Users，返回页面结果，再继续执行jobs的内容了。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/users&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'><span class="no">Processing</span> <span class="n">by</span> <span class="no">UsersController</span><span class="c1">#index as HTML</span>
</span><span class='line'><span class="o">[</span><span class="no">ActiveJob</span><span class="o">]</span> <span class="no">Enqueued</span> <span class="no">AddLotsOfUsersJob</span> <span class="p">(</span><span class="no">Job</span> <span class="ss">ID</span><span class="p">:</span> <span class="mi">50372234</span><span class="o">-</span><span class="mi">6</span><span class="n">cf7</span><span class="o">-</span><span class="mi">4</span><span class="n">ad2</span><span class="o">-</span><span class="n">b886</span><span class="o">-</span><span class="n">fd3029f4ea3d</span><span class="p">)</span> <span class="n">to</span> <span class="no">Sidekiq</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span><span class="ss">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span><span class="n">Z</span> <span class="mi">79432</span> <span class="no">TID</span><span class="o">-</span><span class="n">ouzlum9ig</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">QueueAdapters</span><span class="o">::</span><span class="no">SidekiqAdapter</span><span class="o">::</span><span class="no">JobWrapper</span> <span class="no">JID</span><span class="o">-</span><span class="n">eb96be6e314f6926583a1267</span> <span class="ss">INFO</span><span class="p">:</span> <span class="n">start</span>
</span><span class='line'>  <span class="no">User</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="s2">&quot;users&quot;</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="s2">&quot;users&quot;</span>
</span><span class='line'>  <span class="no">Rendered</span> <span class="n">users</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">erb</span> <span class="n">within</span> <span class="n">layouts</span><span class="o">/</span><span class="n">application</span> <span class="p">(</span><span class="mi">4</span><span class="o">.</span><span class="mi">1</span><span class="n">ms</span><span class="p">)</span>
</span><span class='line'><span class="no">Completed</span> <span class="mi">200</span> <span class="no">OK</span> <span class="k">in</span> <span class="mi">72</span><span class="n">ms</span> <span class="p">(</span><span class="ss">Views</span><span class="p">:</span> <span class="mi">57</span><span class="o">.</span><span class="mi">8</span><span class="n">ms</span> <span class="o">|</span> <span class="ss">ActiveRecord</span><span class="p">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="n">ms</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/jquery_ujs.self-8e98a7a072a6cee1372d19fff9ff3e6aa1e39a37d89d6f06861637d061113ee7.js?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/users.self-e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/jquery.self-d03a5518f45df77341bdbe6201ba3bfa547ebba8ed64f0ea56bfa5f96ea7c074.js?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/application.self-e80e8f2318043e8af94dddc2adad5a4f09739a8ebb323b3ab31cd71d45fd9113.css?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/scaffolds.self-a98ac27100e3e5ca7065dbd7c898e5afa02690ec2ef84ccc02f65c4c20057b83.css?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/turbolinks.self-c37727e9bd6b2735da5c311aa83fead54ed0be6cc8bd9a65309e9c5abe2cbfff.js?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/users.self-877aef30ae1b040ab8a3aba4e3e309a11d7f2612f44dde450b5c157aa5f95c05.js?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="no">Started</span> <span class="no">GET</span> <span class="s2">&quot;/assets/application.self-3a3c8b61bda630ee689740ce7cbd0dd8ea6fdd45e2c42eef4661ab38cf268afe.js?body=1&quot;</span> <span class="k">for</span> <span class="o">::</span><span class="mi">1</span> <span class="n">at</span> <span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span> <span class="mi">12</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">21</span> <span class="o">+</span><span class="mi">0800</span>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span><span class="ss">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="n">Z</span> <span class="mi">79432</span> <span class="no">TID</span><span class="o">-</span><span class="n">ouzlum9ig</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">QueueAdapters</span><span class="o">::</span><span class="no">SidekiqAdapter</span><span class="o">::</span><span class="no">JobWrapper</span> <span class="no">JID</span><span class="o">-</span><span class="n">eb96be6e314f6926583a1267</span> <span class="ss">INFO</span><span class="p">:</span> <span class="ss">done</span><span class="p">:</span> <span class="mi">12</span><span class="o">.</span><span class="mi">828</span> <span class="n">sec</span>
</span></code></pre></td></tr></table></div></figure>


<p>请注意上面的这两句话</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span><span class="ss">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">20</span><span class="n">Z</span> <span class="mi">79432</span> <span class="no">TID</span><span class="o">-</span><span class="n">ouzlum9ig</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">QueueAdapters</span><span class="o">::</span><span class="no">SidekiqAdapter</span><span class="o">::</span><span class="no">JobWrapper</span> <span class="no">JID</span><span class="o">-</span><span class="n">eb96be6e314f6926583a1267</span> <span class="ss">INFO</span><span class="p">:</span> <span class="n">start</span>
</span><span class='line'>
</span><span class='line'><span class="mi">2015</span><span class="o">-</span><span class="mo">04</span><span class="o">-</span><span class="mi">20</span><span class="ss">T04</span><span class="p">:</span><span class="mi">16</span><span class="p">:</span><span class="mi">33</span><span class="n">Z</span> <span class="mi">79432</span> <span class="no">TID</span><span class="o">-</span><span class="n">ouzlum9ig</span> <span class="no">ActiveJob</span><span class="o">::</span><span class="no">QueueAdapters</span><span class="o">::</span><span class="no">SidekiqAdapter</span><span class="o">::</span><span class="no">JobWrapper</span> <span class="no">JID</span><span class="o">-</span><span class="n">eb96be6e314f6926583a1267</span> <span class="ss">INFO</span><span class="p">:</span> <span class="ss">done</span><span class="p">:</span> <span class="mi">12</span><span class="o">.</span><span class="mi">828</span> <span class="n">sec</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-04-19T12:29:08+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/ruby/'>ruby,</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/04/19/how-to-debug-in-rails/" itemprop="url">怎样在rails 中进行调试</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>怎样在 rails 中进行调试</h2>

<h3>背景</h3>

<p>我个人感觉 ruby on rails 是不鼓励调试的，按照设计原则来说，应该是使用测试与 console 来 debug 。但是其实使用断点等调试确实有些时候比较方便，而且其他语言都可以这样做，所以 Ruby on rails 没理由不支持。</p>

<p>大名鼎鼎的 RubyMine 本身当然是实现了这种功能了，但是对于我们这些不喜欢大块头的Vim党来说，怎样处理呢？</p>

<p>答案就是byebug 这个Gem</p>

<h3>gem byebug</h3>

<p>最新的Rails 4.2 已经内置了这个Gem</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># File Gemfile</span>
</span><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Call &#39;byebug&#39; anywhere in the code to stop execution and get a debugger console</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;byebug&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Access an IRB console on exception pages or by using &lt;%= console %&gt; in views</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;web-console&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 2.0&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Spring speeds up development by keeping your application running in the background. Read more: https://github.com/rails/spring</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;spring&#39;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果没有，就自己安装一下</p>

<p>安装完毕之后，在你想加断点的地方加入<code>byebug</code>即可，比如下面</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="n">byebug</span>
</span><span class='line'>      <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;User was successfully created.&#39;</span> <span class="p">}</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:created</span><span class="p">,</span> <span class="ss">location</span><span class="p">:</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:new</span> <span class="p">}</span>
</span><span class='line'>        <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">json</span><span class="p">:</span> <span class="vi">@user</span><span class="o">.</span><span class="n">errors</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:unprocessable_entity</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>当你访问这个页面的时候，rails s 会停留在这里</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="o">[</span><span class="mi">26</span><span class="p">,</span> <span class="mi">35</span><span class="o">]</span> <span class="k">in</span> <span class="sr">/Users/</span><span class="n">atpking</span><span class="o">/</span><span class="no">Code</span><span class="o">/</span><span class="no">Ruby</span><span class="o">/</span><span class="n">my_rails42</span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">controllers</span><span class="o">/</span><span class="n">users_controller</span><span class="o">.</span><span class="n">rb</span>
</span><span class='line'>   <span class="mi">26</span><span class="p">:</span>   <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>   <span class="mi">27</span><span class="p">:</span>     <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span><span class='line'>   <span class="mi">28</span><span class="p">:</span>
</span><span class='line'>   <span class="mi">29</span><span class="p">:</span>     <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>   <span class="mi">30</span><span class="p">:</span>       <span class="n">byebug</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">31</span><span class="p">:</span>       <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>   <span class="mi">32</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;User was successfully created.&#39;</span> <span class="p">}</span>
</span><span class='line'>   <span class="mi">33</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:created</span><span class="p">,</span> <span class="ss">location</span><span class="p">:</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>   <span class="mi">34</span><span class="p">:</span>       <span class="k">else</span>
</span><span class='line'>   <span class="mi">35</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:new</span> <span class="p">}</span>
</span><span class='line'><span class="p">(</span><span class="n">byebug</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>此时我们可以查看在断点处的所有变量信息，基本等效于console。比如下面我来查看@user 下面有什么信息</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>   <span class="mi">26</span><span class="p">:</span>   <span class="k">def</span> <span class="nf">create</span>
</span><span class='line'>   <span class="mi">27</span><span class="p">:</span>     <span class="vi">@user</span> <span class="o">=</span> <span class="no">User</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">user_params</span><span class="p">)</span>
</span><span class='line'>   <span class="mi">28</span><span class="p">:</span>
</span><span class='line'>   <span class="mi">29</span><span class="p">:</span>     <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>   <span class="mi">30</span><span class="p">:</span>       <span class="n">byebug</span>
</span><span class='line'><span class="o">=&gt;</span> <span class="mi">31</span><span class="p">:</span>       <span class="k">if</span> <span class="vi">@user</span><span class="o">.</span><span class="n">save</span>
</span><span class='line'>   <span class="mi">32</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="vi">@user</span><span class="p">,</span> <span class="ss">notice</span><span class="p">:</span> <span class="s1">&#39;User was successfully created.&#39;</span> <span class="p">}</span>
</span><span class='line'>   <span class="mi">33</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:show</span><span class="p">,</span> <span class="ss">status</span><span class="p">:</span> <span class="ss">:created</span><span class="p">,</span> <span class="ss">location</span><span class="p">:</span> <span class="vi">@user</span> <span class="p">}</span>
</span><span class='line'>   <span class="mi">34</span><span class="p">:</span>       <span class="k">else</span>
</span><span class='line'>   <span class="mi">35</span><span class="p">:</span>         <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">render</span> <span class="ss">:new</span> <span class="p">}</span>
</span><span class='line'><span class="p">(</span><span class="n">byebug</span><span class="p">)</span> <span class="vi">@user</span><span class="o">.</span><span class="n">to_json</span>
</span><span class='line'><span class="s2">&quot;{</span><span class="se">\&quot;</span><span class="s2">id</span><span class="se">\&quot;</span><span class="s2">:null,</span><span class="se">\&quot;</span><span class="s2">name</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">atpking</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">born_at</span><span class="se">\&quot;</span><span class="s2">:</span><span class="se">\&quot;</span><span class="s2">2015-04-19</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">created_at</span><span class="se">\&quot;</span><span class="s2">:null,</span><span class="se">\&quot;</span><span class="s2">updated_at</span><span class="se">\&quot;</span><span class="s2">:null}&quot;</span>
</span><span class='line'><span class="p">(</span><span class="n">byebug</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>紧接着是常用的 step、next、continue和quit了</p>

<p>在这里大家可以直接敲首字母，敲完首字母之后直接敲回车，代表的是 <strong>执行上一条指令</strong>
移动执行指针，有step (s)和next(n) 分别对应进入和执行一条语句</p>

<p>continue（c）代表执行直至下一个断点，quit（q）代表退出</p>

<p>有时候我们想查看执行指针附近的代码，则需要输入 list</p>

<p>动态加入断点，则使用break + 行号   如 break 33,  行号可以通过list 查询</p>

<p>当然还有很多复杂高级的用法，但是基本的调试，这些指令就够了。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-04-18T15:18:09+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/04/18/differences-of-proc-dot-new-and-lambda-in-ruby/" itemprop="url">Ruby的Proc.new 与Lambda 的区别</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h2>Ruby的Proc.new 与Lambda 的区别</h2>

<h3>缘起，Block 与 Proc</h3>

<p>Block 在ruby 中会像空气一般的存在于大量的代码当中。块最开始是用来循环时候用的东西，但慢慢的，block变成了委托利器，贯穿于各种代码之间。</p>

<p>举个例子，我有一个数组1,2,3,4,5,6   我想得到这个数组的平方
在传统的程序里面，我们这样实现</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">arr</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'><span class="kd">var</span> <span class="nx">answer</span> <span class="o">=</span> <span class="p">[]</span><span class="err">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">arr</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="nx">i</span><span class="o">++</span><span class="p">){</span>
</span><span class='line'>  <span class="nx">answer</span><span class="p">[]</span> <span class="o">=</span> <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>如果在ruby中，我们即可使用块来完成</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="nx">answer</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">].</span><span class="nx">map</span> <span class="p">{</span><span class="o">|</span><span class="nx">item</span><span class="o">|</span> <span class="nx">item</span><span class="o">**</span><span class="mi">2</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>这里的{|item| item**2} 就是一个Block。</p>

<p>当然之所以这里的ruby 代码简洁的原因是因为map本身隐藏了一些逻辑，实际上map由模块Emuneration 实现
其实通过上面的代码基本上可以看出，Block类似其他语言中的C#或者java中的委托、事件的实现。</p>

<p>我们来仿照着写一个Block的应用（自行实现map）</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span> <span class="o">&lt;</span> <span class="nb">Array</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_map</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="nb">self</span>
</span><span class='line'>      <span class="nb">p</span> <span class="k">yield</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">arr</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">arr</span><span class="o">.</span><span class="n">push</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="n">arr</span><span class="o">.</span><span class="n">my_map</span> <span class="k">do</span> <span class="n">item</span>
</span><span class='line'>  <span class="n">item</span><span class="o">**</span><span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># 结果输出 </span>
</span><span class='line'><span class="c1"># 1</span>
</span><span class='line'><span class="c1"># 9</span>
</span><span class='line'><span class="c1"># 25</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们把目光还是集中在<code>{|item| item **2}</code> 中，这个代码是我们手敲上去的，那有没有方式将其放入变量里呢？
答案是   有，就是Proc对象   就是我们的Proc.new 和lambda，他们会返回Proc对象,记得在做参数的时候要加&amp;符号</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">MyArray</span> <span class="o">&lt;</span> <span class="nb">Array</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_map</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="nb">self</span>
</span><span class='line'>      <span class="k">yield</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">my_map_using_proc</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">proc</span><span class="p">)</span>   <span class="c1"># 定义的时候就需要表示这是个Proc 对象</span>
</span><span class='line'>    <span class="n">answer</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="k">for</span> <span class="n">item</span> <span class="k">in</span> <span class="nb">self</span>
</span><span class='line'>      <span class="c1">#p proc.class    输出为Proc 对象</span>
</span><span class='line'>      <span class="n">answer</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="nb">proc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="k">return</span> <span class="n">answer</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">arr</span> <span class="o">=</span> <span class="no">MyArray</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">arr</span><span class="o">.</span><span class="n">push</span> <span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_proc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">my_lambda</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="n">i</span><span class="o">**</span><span class="mi">2</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">arr2</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">my_map_using_proc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_proc</span><span class="p">)</span>  <span class="c1"># 使用的时候也要说明</span>
</span><span class='line'><span class="nb">p</span> <span class="n">arr2</span>
</span><span class='line'>
</span><span class='line'><span class="n">arr3</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">my_map_using_proc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">my_lambda</span><span class="p">)</span>
</span><span class='line'><span class="nb">p</span> <span class="n">arr3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ruby 下的Proc.new 和Lambda 都是为了生成我们的Proc 而使用的指令，从大方向上来说，他们功能上非常相似，但从细节上来讲，他们又有一些不同点</p>

<p>相同点非常简单，他们都返回Proc对象，结构一样，那么不同点呢？</p>

<ol>
<li>Proc.new 的参数不需要严格匹配，但是lambda 需要严格匹配</li>
</ol>


<p>  比如这里的<code>func1 = Proc.new {|p,q| p p,q};func1.call("x")</code>， 则输出 <code>"x" nil</code>，但是换做lambda，就不行：</p>

<pre><code class="``">  2.2.0 :014 &gt; func2 = lambda {|p,q| p p,q};func2.call("x")
ArgumentError: wrong number of arguments (1 for 2)
  from (irb):14:in `block in irb_binding'
  from (irb):14:in `call'
  from (irb):14
  from /Users/atpking/.rvm/rubies/ruby-2.2.0/bin/irb:11:in `&lt;main&gt;'
</code></pre>

<ol>
<li>Proc.new 如果里面出现了return，则代表的外部的return，而不是Proc自己的return,则是返回一个Proc对象，比如说</li>
</ol>


<pre><code class="``">  2.2.0 :035 &gt; def Hello
  2.2.0 :036?&gt;   p = Proc.new{return "inner proc"}
  2.2.0 :037?&gt;   p.call
  2.2.0 :038?&gt;   return "func return"
  2.2.0 :039?&gt;   end
  2.2.0 :041 &gt; Hello()
   =&gt; "inner proc"
</code></pre>

<p>注意此处，返回的是inner proc,
注意，如果直接在irb 里写p = Proc.new{return 1}<br/>
之后p.call 的化，是要报localJumpError的，因为此时irb 并没有结束,还没有return</p>

<pre><code class="``">  2.2.0 :061 &gt; def Hello2
  2.2.0 :062?&gt;   p = lambda{return "inner proc"}
  2.2.0 :063?&gt;   p.call
  2.2.0 :064?&gt;   return "func return"
  2.2.0 :065?&gt;   end
   =&gt; :Hello2
  2.2.0 :068 &gt; Hello2()
   =&gt; "func return"
</code></pre>

<p>此处是func return。</p>

<p>那么这些区别会带来什么变化呢？答案是，lambda 可以带参数的回传， 更加灵活了。比如下面的一个例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">087</span> <span class="o">&gt;</span> <span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">088</span><span class="o">?&gt;</span>   <span class="n">b</span> <span class="o">=</span> <span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="k">return</span> <span class="n">item</span><span class="o">*</span><span class="n">n</span> <span class="p">}</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">089</span><span class="o">?&gt;</span>   <span class="k">end</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="ss">:my_func</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">090</span> <span class="o">&gt;</span> <span class="n">my_func</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">call</span> <span class="mi">5</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="mi">10</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">091</span> <span class="o">&gt;</span> <span class="n">my_func</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Proc</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">092</span> <span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>而proc，就会出现下列的问题</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">094</span> <span class="o">&gt;</span> <span class="k">def</span> <span class="nf">my_func</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">095</span><span class="o">?&gt;</span>   <span class="n">b</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="n">item</span><span class="o">|</span> <span class="k">return</span> <span class="n">item</span><span class="o">*</span><span class="n">n</span> <span class="p">}</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">096</span><span class="o">?&gt;</span>   <span class="k">end</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="ss">:my_func</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">097</span> <span class="o">&gt;</span> <span class="n">my_func</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">class</span>
</span><span class='line'> <span class="o">=&gt;</span> <span class="no">Proc</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">098</span> <span class="o">&gt;</span> <span class="n">my_func</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">call</span> <span class="mi">5</span>
</span><span class='line'><span class="ss">LocalJumpError</span><span class="p">:</span> <span class="n">unexpected</span> <span class="k">return</span>
</span><span class='line'>  <span class="n">from</span> <span class="p">(</span><span class="n">irb</span><span class="p">):</span><span class="mi">95</span><span class="ss">:in</span> <span class="sb">`block in my_func&#39;</span>
</span><span class='line'><span class="sb">  from (irb):98:in `</span><span class="n">call</span><span class="s1">&#39;</span>
</span><span class='line'><span class="s1">  from (irb):98</span>
</span><span class='line'><span class="s1">  from /Users/atpking/.rvm/rubies/ruby-2.2.0/bin/irb:11:in `&lt;main&gt;&#39;</span>
</span><span class='line'><span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mi">099</span> <span class="o">&gt;</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2015-01-27T11:35:32+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">

</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2015/01/27/sync-my-time-log-to-google-calendar/" itemprop="url">同步时间日志到谷歌日历</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<h1>背景</h1>

<blockquote><p>既然“管理时间”是不可能的，那么解决方法就只能是，想尽一切办法真正了解自己，真正了解时间、精确地感知时间；而后再想尽一切办法是自己以及自己的行为与时间“合拍”，就是我的说法&ndash;“与时间做朋友”</p>

<p><strong>&mdash;-李笑来，把时间当做朋友</strong></p></blockquote>

<p>这个项目的灵感来自于一本叫做<a href="http://book.douban.com/subject/1115353/">《奇特的一生》</a>的一本书，这本书描述的主人公擅长把自己的时间记录起来，之后做一些分析统计，从而提高自己对时间的利用。</p>

<p>在主人公的时代，纸和笔是记录的方式，在我们的时代，就喜欢电子化了。</p>

<p>我最开始是通过APP 操作，将数据写入 <strong>谷歌日历</strong> 上的，但是我发现了一些问题：</p>

<ul>
<li>打开日历太麻烦了</li>
<li>日历的时间选择很麻烦，要点很多次手机屏幕，还得精确操作</li>
<li>选完日期还得选标题 又要切换</li>
</ul>


<p>我觉得更快速的方式应该是使用 Evernote 直接以文本形式来记录时间开销，直接打字就好了，不用转换，而且同步起来个人觉得还是挺方便的</p>

<p>但是文字记录可视化程度不高，很难直观的看出时间利用率，那么我们就简单点，写个程序，将文字转化为Google Calendar 的事件。</p>

<p>我在做拆字的时候，有一个原则，就是    文字输入，一定要简单
这是一条典型的记录</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1000 1130 做RubyOnRails的练习
</span></code></pre></td></tr></table></div></figure>


<p>代表从10点到11点30 做了ruby on rails 的练习。</p>

<hr />

<h1>初次使用配置</h1>

<h2>1. 确认能访问Google的服务器</h2>

<p>没什么好说的，不行就挂VPN</p>

<h2>2. 开启Google Calendar API,授权为Service account</h2>

<p><strong>为何是Service Account </strong> ?</p>

<p>因为我觉得证书登陆比输入密码简单，还不受Cookie的影响什么的，也许以后会改成Desktop Account</p>

<p><strong> 怎样开启 </strong></p>

<ol>
<li>拥有Google 账户</li>
<li>使用这个账户去开启一个新的Project 项目 <a href="https://console.developers.google.com/project">https://console.developers.google.com/project</a></li>
<li>点击进入你新开的Project 账户，进入API，打开 Google+ (用来做用户验证) 和 Google calendar 的API</li>
<li>进入credential 凭证，在OAuth 建立新的Client ID ，之后选择<strong>service account</strong>,保存，之后系统会提示你下载一个 p12结尾的签名文件，存好了别掉了，这是登录的凭证</li>
</ol>


<h2>3. 添加Google Project 里 Service Account 的Email 到 Google Calendar 的你记录时间的日历的共享账户，并将其权限选择为“拥有这个日历”</h2>

<p> <code>**非常重要，我被坑了好久**</code>  你会在你申请的Project 看到在Oauth下的Service account 有一个Email Address  请把这个地址添加到你Google Calendar 里记录时间的日历的账户共享中</p>

<p> 如果你不这么做，<strong>程序就读不到这个日历</strong></p>

<h2>4. 确认拥有Ruby 环境</h2>

<p>安装ruby请移步<a href="https://github.com/ruby-china/ruby-china/wiki/Mac-OS-X-%E4%B8%8A%E5%AE%89%E8%A3%85-Ruby">ruby china 的教程</a></p>

<h2>5. 安装对应Gem &amp;&amp; 修改配置文件</h2>

<p>脚本运行</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>git clone https://github.com/jicheng1014/timelog_to_google_cal
</span><span class='line'>cd timelog_to_google_cal
</span><span class='line'>bundle install
</span><span class='line'>touch raw.txt</span></code></pre></td></tr></table></div></figure>


<p>之后把刚下载的.p12 的签名文件保存到项目同级目录下。</p>

<p>修改配置文件 config.yml ，修改 service_account_email  和key_file 的具体值</p>

<hr />

<h1>日志格式格式</h1>

<p>我在做日志格式的时候，有一个原则，就是 文字输入，一定要简单,无论是在电脑上写，还是在手机、平板上输入，都应该力图简洁。</p>

<p>默认是在raw.txt 中写日志，当然我自己是这么干的，写在Evernote 里，之后需要将数据展现的时候，再拷贝到这个文件当中</p>

<p>格式为</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>开始时间 结束时间 做的事情</span></code></pre></td></tr></table></div></figure>


<ul>
<li>使用24小时进制</li>
<li>时间为双位，中间没有空格  如下午1点30分   则是1330</li>
<li>24点为0点，系统会自动增加一天（对夜猫子友好） 如<code>2330 0010 跑步</code> 代表 晚上11点30到凌晨24:10 跑步</li>
</ul>


<p>这是一条典型的记录</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>1000 1130 做RubyOnRails的练习
</span><span class='line'>1130 1215 吃饭
</span><span class='line'>
</span><span class='line'>2300 0010 跑步
</span></code></pre></td></tr></table></div></figure>


<hr />

<h1>使用方法</h1>

<p>项目目录下输入 <code>ruby my_date_log [日期差] [日志文件名]</code></p>

<p><strong>日期差</strong></p>

<p>考虑到有可能在晚上0点之后更新，故可减少天数，比如现在是凌晨0147 我的日志记录的实际上是昨天的内容，则我的日期差就是 1</p>

<p>即可执行<code>ruby my_date_log 1</code>  可不填写，默认是0</p>

<p><strong>日志文件</strong></p>

<p>日志的文件名，默认是raw.txt</p>

<h2>特别说明</h2>

<ul>
<li>当你多次同步某天的日志到日历的时候也是可以的，程序会自动删除日志当天的老数据（根据内容标签为日志当天日期，你可以在Google Calendar 里点一个日志看他的详细内容，就是以那个为标注删除的）</li>
<li>联系方式 atpking#gmail com</li>
</ul>


<hr />

<h1>TODO</h1>

<ul>
<li>直接通过Evernote 的API获取日志，之后自动的同步到Google Calendar</li>
<li>做成指令，之后不在项目当前路径上输入</li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-12-01T01:40:29+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/za-tan/'>杂谈</a>, <a class='category' href='/blog/categories/gou-wu/'>购物</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/12/01/buy-buy-buy/" itemprop="url">买买买，该买的，始终是要买的</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>今年其实买了很多东西，从最开始的hi-vps，之后是macbook pro，再是macbook pro，iphone 6 plus, 还有linode的主机，
今天，又买了一个<strong>大件</strong> <code>codeschool</code>的一年期会员</p>

<p>老美黑色星期五打折，收到邮件说codeschool 现在只要189 USD就可以混一年，以前看过1-2期codeschool 的视频，感觉不错，主持人蛮幽默的.外加制作个人觉得还是比较用心，有一定的水准，但是因为穷癌导致一直没有入手。</p>

<p>其实190USD差不多只折合人民币不到1200块，相当于每个月100块，一天3.3，还没口香糖烧钱，但身为非90互联网原住民，还是有一些思维上的劣势，感觉买这种在线教育类的，总是觉得花上千块略奢侈</p>

<p>当然其实从道理上我还是能理解 金钱换知识是划算的，从逻辑上能够推理出来这笔投资是值得的。</p>

<p>仔细回忆了下今年买的虚拟物品，其实还是蛮多的，小列出来一下</p>

<ul>
<li>hi-vps</li>
<li>阿里云主机 若干</li>
<li>greenvpn</li>
<li>linode vps</li>
<li>电子书若干本 (主要在多看买，似乎还在另外的平台买了几本部署、测试的书，还好都不贵)</li>
<li>史上最坑爹的 air display 2 (特别列出此app,刷新率低的吓人，请广大群众注意，千万别买)</li>
<li>其他apps (不超过100)</li>
<li>railscasts 的一个月会员 (由于版主没更新，所以一直只花了一个月，自动续期)</li>
<li>doit.im 一年会员</li>
<li>pomotodo 一年期会员</li>
<li>迅雷一年期白金会员（估计不会续费了  哈哈哈哈哈哈哈）</li>
<li>codeschool 一年期会员</li>
</ul>


<p>这么一看，还是买了不老少，目前感觉最划算的时linode   除了当主机用，还肩负着ssh 端口转发以及自建vpn的光荣任务，最不值的就是air display2，retina屏幕扩展几本没办法用，卡的直接崩溃，60多块吧，记不清了</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-29T11:35:47+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/capistrano/'>capistrano</a>, <a class='category' href='/blog/categories/rails/'>rails</a>, <a class='category' href='/blog/categories/vagrant/'>vagrant</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/11/29/rails-nginx-config/" itemprop="url">昨日rails 在vagrant上使用capistrano实现自动化部署rails的一些记录</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>昨天折腾了一天关于vagrant、capistrano 部署rails程序，
可能是因为自己不是很懂，基本上搞了一天最后才搞出一点点名堂,
很是惭愧</p>

<p>关于vagrant ，是一个可用于快速配置开发环境的一个虚拟机的应用，可以将常规项目放到虚拟机中进行开发，
官方是说vagrant是用来统一项目组的开发环境云云，其实我觉得倒也还好，真正要统一环境还不如去玩docker，
个人使用vagrant的最方便的就是可以先在自己的机器上实验部署环境，而又不用去运行完整的系统（比如我放的ubuntu 14.04）,
另外一个比较方便的是vagrant 和宿主机器传文件特别方便，实际上是公用一个文件夹
最后的一个比较伤心的理由是你要真正的在virtualbox上跑ubuntu实际上还是略吃资源的，而vagrant上跑它优化过的ubuntu，应该是砍掉了一些资源，
硬盘消耗的略小一些，这样拥有屌丝120G 硬盘的mbp的我不会因为虚拟机而占太多硬盘</p>

<p>在这里推荐happycasts网站的一个视频，我觉得peter的这期视频应该是说的很清楚了，有兴趣的朋友可以<a href="http://happycasts.net/episodes/105">点击这里</a>查看一下</p>

<p>关于capistrano这个自动化部署工具，最开始我把它想的十分复杂，觉得应当从官方网站一行一行的读，由于ruby和英文都不是恨过关，结果非常痛苦，耗费了很多时间。
我不是说啃官方的document不好，这个capistrano的官网写的有些详细，陡然看上去感觉不太好懂（或者我比较愚钝），应该是有所了解了再上这个懒人包，感觉效果会好一些</p>

<p>这里我要说明一些capistrano的使用的一个细节</p>

<p>capistrano 是一个部署每次都要用的东西，所以，如果只需要运行一次的东西，是否有必要写成task？如果要发布到多个计算机上，需要（或者使用一个叫做chef 的工具），如果只有一台服务器，写task的麻烦程度是大于自己配置</p>

<p>我觉得capistrano管理的是每次发布时都需要做的事情，而不是单独一次发布的时候做的事情</p>

<p>另外，capistrano 也没有自动化到可以帮你安装nginx、passenger、rvm，写配置的程度（也许可以，只是很麻烦）,所以这个要在新服务器自己部署搞定</p>

<p>可以参考下这篇文章，案例是使用rbenv的，替换成rvm即可，<a href="http://www.gotealeaf.com/blog/deploy-rails-apps-with-capistrano">Use Capistrano 3 to Deploy Rails Applications - a Step-by-Step Tutorial</a></p>

<p>我当时做的时候有个小插曲：当一切配置完毕的时候 访问这个rails程序，始终报403 错误，但是我current/public 权限肯定够读的。
几经研究之后，发现是nginx的一个配置问题：我使用的是默认的server，它里面有一个location / { &hellip; } 的配置，这个location这段删掉即可（<code>原理未知</code>,求解答）</p>

<p>另外使用capistrano 部署后，直接使用bundle 命令在服务器做事情似乎是不行的   需要使用rvm 指定才行，类似这样
<code>~/.rvm/bin/rvm default do bundle exec rake assets:precompile</code></p>

<p>之后直接在服务器运行rails 命令也会失败，我是又再服务器运行了gem install rails 才能使用的</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
	<div class="meta">
		<div class="date">








  


<time datetime="2014-11-24T00:54:57+08:00" data-updated="true" itemprop="datePublished"></time></div>
		<div class="tags">


	<a class='category' href='/blog/categories/mobilenetwork/'>mobilenetwork</a>, <a class='category' href='/blog/categories/sui-xiang/'>随想</a>


</div>
		
	</div>
	<h1 class="title" itemprop="name"><a href="/blog/2014/11/24/talk-about-mobile-network/" itemprop="url">关于移动互联网的一小搓内容</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>今天跟老爸打电话，聊天中，我得知了一个很有意思的事情。
我老爸告诉我，他手机流量用超了，超了80多M.
我说，这是正常的，我也偶尔超一下，下次办一个稍微大点的流量包就可以了。之后顺便问了下老爸流量包办的是多大的，
他的回答，让我有些意外</p>

<h2>700MB</h2>

<p>想起我自己的plus，也只是办了400MB的流量。一般一个月也就差不多300-500M左右</p>

<p>一位中老年人在移动网络上花去了超过700M流量，如果有1/100的中老年有这种强需求，那这块的市场有多大？</p>

<p>我就在想，现在的移动互联网市场是不是过分的针对着年轻人，还忽略了一块叫做中老年的用户群体？
我们做IT的总是习惯于把自己的用户定位成15-30岁的年轻人，总觉得人一旦上了年龄了，就不会玩互联网这一套了
但是在我的感觉里，似乎越来越多的中老年，也开始加入到互联网，特别是移动互联网的领域当中了
而且，他们通常，还有一个可以支付他们消费的子女</p>

		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner">Copyright &copy; 2016

    Atpking


Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






		</div>
	</div>
</body>
</html>
